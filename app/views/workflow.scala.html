@import forms._
@(form : FormDefinition)

<ul id="navbar">
    <li><a href="@routes.Application.index">Home</a></li>
    <li><a href="@routes.Application.builder">Workflow Builder</a></li>
    <li><a href="@routes.Application.createaccount">Register</a></li>
    @if(session.get("uid") == null) {
        <li><a href="@routes.Application.login">Login</a></li>
    } else {
        <li><a href="@routes.Application.logout">Logout</a></li>
    }
</ul>

@main(title = "The Kurator 'helloworld' application") {

    <h1>@form.title</h1>

     <script type="text/javascript">
        $(function() {
            $("#complete").hide();
            $("#run").prop("disabled", true);

            $("#progressbar").progressbar({
                value: false
            }).hide();

            $("#overlay").hide();
            $("#modal").hide();

            // grab your file object from a file input
            $('#input').change(function () {
                $("#overlay").show("fade");

                var file = this.files[0];
                $.ajax({
                    type: 'post',
                    url: 'upload',
                    data: file,
                    success: function (data) {
                        console.log(data)
                        $("#progressbar").hide("fade");
                        $("#run").prop("disabled", false);

                        $("#modal").show("fade");
                        setTimeout(function() {
                            $("#modal").hide("fade");
                            $("#overlay").hide("fade");
                        }, 1000);
                    },
                    error: function (request, status, error) {
                        $("#progressbar").hide("fade");
                        $("#error").html(error);
                    },
                    processData: false,
                    contentType: file.type
                });
            });

            $("#runWorkflow").submit(function (event) {
                event.preventDefault();
                var formData = new FormData($(this)[0]);

                $.ajax({
                    url: "@routes.Workflow.test(form.name)",
                    type: "POST",
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (returndata) {
                        alert(formData);
                    },
                    error: function () {
                        alert("error in ajax form submission");
                    }
                });

                return false;
            });

            $("#run").click(function() {
                $("#progressbar").show("fade");
                jsRoutes.controllers.Workflow.rungeo().ajax({
                    success: function (data) {
                        $("#result").html(data.output);
                        $("#download").attr("href", "result/" + data.runId);
                        console.log(data)
                        $("#progressbar").hide("fade");
                        $("#complete").show("drop");
                    },
                    error: function (request, status, error) {
                        $("#progressbar").hide("fade");
                        $("#error").html(data);
                    }
                });
            });
        });
     </script>

<form id="runWorkflow" enctype="multipart/form-data">
    <table>
        @for((name, field) <- form.fields) {
        <tr>
            @field match {
            case fileInput: input.FileInput => {
            <td>@fileInput.label</td><td><input type="file" id="@fileInput.name" name="@fileInput.name"></td>
            }
            case textField: input.TextField => {
            <td>@textField.label</td>

            @if(textField.isTextArea) {
            <td><textarea name="@textField.name"></textarea></td>
            } else {
            <td><input type="text" name="@textField.name"></td>
            }
            }
            case radioGroup: input.RadioGroup => {
            <td>@radioGroup.label</td>

            <td>
                @for(option <- radioGroup.options) {
                <input type="radio" name="@radioGroup.name" value="@option.value" @if(radioGroup.value == option) { checked="checked" }>@option.label</input>
                }
            </td>
            }
            case checkBox: input.CheckBox => {
            <td colspan="2"><input type="checkbox" name="@checkBox.name">@checkBox.label</input></td>
            }
            case selectField: input.SelectField => {
            <td>@selectField.label</td>

            <td>
                <select name="@selectField.name">
                    @for(option <- selectField.options) {
                    <option value="@option.value">@option.label</option>
                    }
                </select>
            </td>
            }
            }
        </tr>
        }
        <tr><td colspan="2"><input type="submit" value="Run Workflow"/><input type="reset" /></td></tr>
    </table>
    </form>

    <div id="progressbar" class="ui-progressbar-indeterminate"></div>
    <div id="complete">
        Result: <span id="result"></span>
        <a id="download">Download csv...</a>
    </div>
    <div id="error"></div>

    <br />
    <div id='overlay'></div>
    <div id='modal'>
        <div id='content'>File upload complete!</div>
    </div>
}

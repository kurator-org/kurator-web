
@main(title = "The Kurator 'helloworld' application") {

<h1>Workflow Builder</h1>
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script src="@routes.Assets.at("javascripts/jsPlumb-2.1.4.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/dropzone.js")" type="text/javascript"></script>

    <script src="@routes.Assets.at("javascripts/demo.js")" type="text/javascript"></script>

<script type="text/javascript">
    jsPlumb.ready(function() {
        jsPlumb.setContainer($("#canvas"));

        var base = document.getElementsByTagName('base')[0];
        if (base && base.href && (base.href.length > 0)) {
            base = base.href;
        } else {
            base = document.URL;
        }
        var context = base.substr(0,
                base.indexOf("/", base.indexOf("/", base.indexOf("//") + 2) + 1));

        function addActor(name, type, strategies) {
            if (!strategies) {
                var actor = $("<div id='" + name +"'class='" + type + "'>" + name + "</div>");
            } else {
                var actor = $("<div id='" + name +"'class='" + type + "'><span>" + name + "<span> </div>");

                var select = $("<select></select>").change(function() {
                    var strategy = $(this).find(":selected").text();
                    $.post(context + "/actor/set/" + name + "?strategy=" + strategy, function(data) {
                        console.log(data);
                    });
                });

                $.each(strategies, function(index, strategy) {
                    select.append("<option>" + strategy + "</option>");
                });

                actor.append(select);
            }

            actor.dblclick(function () {
                jsPlumb.remove(this);
                var actorName = name;
                $.post(context + "/actor/remove/" + actorName, function (data) {
                    console.log(data);
                });
            });

            $("#canvas").append(actor);
            jsPlumb.draggable(name);

            if (type === "actor") {
                var inEnpoint = jsPlumb.addEndpoint(actor, {
                    anchor: "Left",
                    isTarget: true,
                });
                var outEnpoint = jsPlumb.addEndpoint(actor, {
                    anchor: "Right",
                    isSource: true
                });
            } else if (type === "input") {
                var outEnpoint = jsPlumb.addEndpoint(actor, {
                    anchor: "Right",
                    isSource: true
                });
            } else if (type === "output") {
                initWebSocket();
                var inEnpoint = jsPlumb.addEndpoint(actor, {
                    anchor: "Left",
                    isTarget: true,
                });
            }


        }

        jsPlumb.bind("beforeDrop", function(data) {
            console.log("drop")
            console.log("source: " + data.sourceId);
            console.log("target: " + data.targetId);

            $.post(context + "/actor/connect?source=" + data.sourceId + "&target=" + data.targetId, function (data) {
                console.log(data);
            })

            return true;
        });

        jsPlumb.bind("beforeDetach", function(data) {
            console.log("detach")
            console.log("source: " + data.sourceId);
            console.log("target: " + data.targetId);

            $.post(context + "/actor/detach?source=" + data.sourceId + "&target=" + data.targetId, function (data) {
                console.log(data);
            })

            return true;

        });

        $.get(context + "/builder/list", function (data) {
            $.each(data, function (index, value) {
                $("#actors").append("<option>"+ value + "</option>");
            });
        });

        $("#add").click(function () {
            var actorName = $("#actors").val();

            $.post(context + "/actor/add/" + actorName, function (data) {
                console.log(data);
                addActor(data.actor, data.type, data.strategies);
            })

        });

        $("#console").hide();

        $("#showConsole").click(function() {
            $("#console").toggle("slide");
        });

        // Selection box

        var selection = $("<div>").addClass("selection-box");
        var select_top, select_right, select_left, select_bottom;
        var dragging = false;

        var selected = [];

        $("#canvas").mousedown(function(e) {
            selected.forEach(function(item) {
                item.removeClass("selected")
                jsPlumb.removeFromPosse(item, "selection");
            });

            selected = [];

            var click_x = e.pageX;
            var click_y = e.pageY;


            selection.css({
                "top": click_y,
                "left" : click_x,
                "width": 0,
                "height" : 0
            });

            selection.appendTo($(this));

            $(this).on("mousemove", function(e) {
                dragging = true;

                var move_x = e.pageX,
                        move_y = e.pageY,
                        width  = Math.abs(move_x - click_x),
                        height = Math.abs(move_y - click_y),
                        new_x, new_y;

                new_x = (move_x < click_x) ? (click_x - width) : click_x;
                new_y = (move_y < click_y) ? (click_y - height) : click_y;

                selection.css({
                    "width": width,
                    "height": height,
                    "top": new_y,
                    "left": new_x
                });

                select_top = new_y;
                select_right = new_x + width;
                select_bottom = new_y + height;
                select_left = new_x;
            });

            $(this).mouseup(function(e) {
                if (dragging) {
                    dragging = false;

                    $(".actor").each(function() {
                        var top = this.getBoundingClientRect().top;
                        var bottom = this.getBoundingClientRect().bottom;
                        var left = this.getBoundingClientRect().left;
                        var right = this.getBoundingClientRect().right;

                        if (select_top < top && select_left < left && select_right > right && select_bottom > bottom) {
                            selected.push($(this));
                            $(this).addClass("selected");
                            jsPlumb.addToPosse($(this), "selection");
                        }
                    });
                }

                $(this).off("mousemove");
                selection.remove();
            });
        }).mouseleave(function(e) {
            $(this).off("mousemove");
            selection.remove();
        });

    });
</script>


    <form action="@routes.DemoController.upload" class="dropzone"></form>

    <br />

    <select name="actors" id="actors"></select>
    <button id="add">Add Actor</button> <button id="showConsole">Toggle Console</button>
    <div id="canvas"></div>

    <div id="console">
        <div id="output"></div>
        <div class="chart"></div>
    </div>

}

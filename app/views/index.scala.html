@import forms._
@(workflows : List[FormDefinition])(userUploads : List[UserUpload])

<ul id="navbar">
    <li><a class="active" href="@routes.Application.index">Home</a></li>
    <li><a href="@routes.Application.builder">Workflow Builder</a></li>
    @if(session.get("uid").equals("0")) {
        <li><a href="@routes.Application.admin">User Management</a></li>
    }
    @if(session.get("uid") == null) {
        <li><a href="@routes.Application.register">Register</a></li>
        <li><a href="@routes.Application.login">Login</a></li>
    } else {
        <li><a href="@routes.Application.logout">Logout</a></li>
    }
</ul>

@main(title = "The Kurator 'helloworld' application") {

    <h1>Workflows</h1>

    <script type="text/javascript">
            $(function() {

                function updateWorkflowRuns(data) {
                    if (data.length != 0) {
                        data.sort(function(a, b) {
                            return new Date(b.startTime).getTime() - new Date(a.startTime).getTime();
                        });

                        var html = "    <table>" +
                                "        <tr>" +
                                "            <th>Workflow</th>" +
                                "            <th>Start Time</th>" +
                                "            <th>End Time</th>" +
                                "            <th>Result</th>" +
                                "            <th>Output Log</th>" +
                                "            <th>Error Log</th>" +
                                "        </tr>";

                        $.each(data, function(i, val) {
                            html += "        <tr>" +
                                    "            <td>" + val.workflow + "</td>" +
                                    "            <td>" + val.startTime + "</td>" +
                                    "            <td>" + (val.endTime != null ? val.endTime : "Running...") + "</td>" +
                                    "            <td>" + (val.hasResult ? "<a href=\"result/" + val.id + "\">Download</a>" : "Unavailable") + "</td>" +
                                    "            <td>" + (val.hasOutput ? "<a href=\"output/" + val.id + "\">Output log</a>" : "No Output") + "</td>" +
                                    "            <td>" + (val.hasErrors ? "<a href=\"error/" + val.id + "\">Error log</a>" : "No Errors") + "</td>" +
                                    "        </tr>";
                        });

                        html += "    </table>";
                        $("#workflowRuns").html(html);
                    }
                    console.log(data);
                }

                $.ajax({ url: "@routes.Workflows.status(session.get("uid"))", success: updateWorkflowRuns});

                (function poll() {
                    setTimeout(function() {
                        $.ajax({ url: "@routes.Workflows.status(session.get("uid"))", success: updateWorkflowRuns, dataType: "json", complete: poll });
                    }, 3000);
                })()
            })

            /*;*/
    </script>

    <table>
        @workflows.map { workflow =>
            <tr>
                <td>
                    @if(workflow.documentation != null) {
                        <a href="@workflow.documentation"><img src="@routes.Assets.at("images/info.png")" /></a>
                    }
                </td>
                <td>
                    @workflow.title
                </td>
                <td>
                    <a href="workflow/@workflow.name">Run</a>
                </td>
            </tr>
        }
    </table>

    <h1>Workflow runs (Most recent first)</h1>
    <div id="workflowRuns"></div>
    
}
